---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection(
    "blog",
    (entry: CollectionEntry<"blog">) => !entry.data.draft,
  );
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: CollectionEntry<"blog"> };
const { Content } = await post.render();

// Get all posts sorted by date (newest first) for navigation
const allPosts = await getCollection(
  "blog",
  (entry: CollectionEntry<"blog">) => !entry.data.draft,
);

allPosts.sort(
  (a, b) =>
    new Date(b.data.date as any).getTime() -
    new Date(a.data.date as any).getTime(),
);

// Find current post index and get prev/next
const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);
const prevPost =
  currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null; // Older post
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null; // Newer post
---

<Base
  title={`${post.data.title} — andarms`}
  description={post.data.description ?? undefined}
>
  <article class="prose">
    <h1>{post.data.title}</h1>
    <p class="muted">{new Date(post.data.date as any).toLocaleDateString()}</p>
    {
      post.data.tags && post.data.tags.length > 0 && (
        <div class="tags">
          {post.data.tags.map((tag) => (
            <a href={`/tags/${tag}`} class="tag">
              #{tag}
            </a>
          ))}
        </div>
      )
    }
    <Content />
  </article>

  {
    (prevPost || nextPost) && (
      <nav class="post-navigation" aria-label="Post navigation">
        <div class="nav-links">
          {prevPost && (
            <a
              href={`/blog/${prevPost.slug}`}
              class="nav-link nav-prev"
              rel="prev"
            >
              <span class="nav-label">← Previous</span>
              <span class="nav-title">{prevPost.data.title}</span>
            </a>
          )}
          {nextPost && (
            <a
              href={`/blog/${nextPost.slug}`}
              class="nav-link nav-next"
              rel="next"
            >
              <span class="nav-label">Next →</span>
              <span class="nav-title">{nextPost.data.title}</span>
            </a>
          )}
        </div>
      </nav>
    )
  }
</Base>
